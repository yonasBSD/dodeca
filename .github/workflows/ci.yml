# GENERATED BY: cargo xtask ci
# DO NOT EDIT - edit xtask/src/ci.rs instead

---
name: CI
"on": 
  push: 
    branches: 
      - main

  pull_request: 
    branches: 
      - main

jobs: 
  check-windows: 
    name: Check (Windows)
    runs-on: depot-windows-2022-16
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with: 
          targets: wasm32-unknown-unknown

      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Install wasm-pack
        run: cargo install wasm-pack
        shell: bash
      - 
        name: Build
        run: cargo xtask build
        shell: bash
      - 
        name: Check
        run: cargo check --all-features
        shell: bash

  build-ddc-linux: 
    name: Build ddc (linux)
    runs-on: depot-ubuntu-24.04-16
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with: 
          components: clippy
          targets: wasm32-unknown-unknown

      - 
        name: Install Rust (nightly)
        uses: dtolnay/rust-toolchain@nightly
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Install wasm-pack
        run: "curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh"
      - 
        name: Build WASM
        run: cargo xtask wasm
      - 
        name: Build ddc
        run: cargo build --release -p dodeca
      - 
        name: Verify ddc binary exists
        run: ls -la target/release/ddc
      - 
        name: Run ddc unit tests
        run: cargo test --release -p dodeca --lib
      - 
        name: Clippy
        run: cargo clippy --all-features --all-targets -- -D warnings
      - 
        name: Upload artifact
        uses: actions/upload-artifact@v4
        with: 
          name: ddc-linux
          path: target/release/ddc


  build-plugins-image-linux: 
    name: Build plugins/image (linux)
    runs-on: depot-ubuntu-24.04-16
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Build image plugins
        run: cargo build --release -p dodeca-webp -p dodeca-jxl -p dodeca-image
      - 
        name: Test image plugins
        run: cargo test --release -p dodeca-webp -p dodeca-jxl -p dodeca-image
      - 
        name: Upload plugin artifacts
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-image-linux
          path: "target/release/libdodeca_webp.so\ntarget/release/libdodeca_jxl.so\ntarget/release/libdodeca_image.so"
          retention-days: "1"


  build-plugins-web-linux: 
    name: Build plugins/web (linux)
    runs-on: depot-ubuntu-24.04-16
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Build web plugins
        run: cargo build --release -p dodeca-minify -p dodeca-css -p dodeca-sass -p dodeca-html-diff
      - 
        name: Test web plugins
        run: cargo test --release -p dodeca-minify -p dodeca-css -p dodeca-sass -p dodeca-html-diff
      - 
        name: Upload plugin artifacts
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-web-linux
          path: "target/release/libdodeca_minify.so\ntarget/release/libdodeca_css.so\ntarget/release/libdodeca_sass.so\ntarget/release/libdodeca_html_diff.so"
          retention-days: "1"


  build-plugins-misc-linux: 
    name: Build plugins/misc (linux)
    runs-on: depot-ubuntu-24.04-16
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Build misc plugins
        run: cargo build --release -p dodeca-fonts -p dodeca-pagefind -p dodeca-linkcheck -p dodeca-svgo -p dodeca-baseline
      - 
        name: Test misc plugins
        run: cargo test --release -p dodeca-fonts -p dodeca-pagefind -p dodeca-linkcheck -p dodeca-svgo -p dodeca-baseline
      - 
        name: Upload plugin artifacts
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-misc-linux
          path: "target/release/libdodeca_fonts.so\ntarget/release/libdodeca_pagefind.so\ntarget/release/libdodeca_linkcheck.so\ntarget/release/libdodeca_svgo.so\ntarget/release/libdodeca_baseline.so"
          retention-days: "1"


  build-plugins-js-linux: 
    name: Build plugins/js (linux)
    runs-on: depot-ubuntu-24.04-16
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Build js plugins
        run: cargo build --release -p dodeca-js
      - 
        name: Test js plugins
        run: cargo test --release -p dodeca-js
      - 
        name: Upload plugin artifacts
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-js-linux
          path: target/release/libdodeca_js.so
          retention-days: "1"


  build-plugins-code-linux: 
    name: Build plugins/code (linux)
    runs-on: depot-ubuntu-24.04-16
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Build code plugins
        run: cargo build --release -p dodeca-code-execution
      - 
        name: Test code plugins
        run: cargo test --release -p dodeca-code-execution
      - 
        name: Upload plugin artifacts
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-code-linux
          path: target/release/libdodeca_code_execution.so
          retention-days: "1"


  integration-linux: 
    name: Integration (linux)
    runs-on: depot-ubuntu-24.04-16
    needs: 
      - build-ddc-linux
      - build-plugins-image-linux
      - build-plugins-web-linux
      - build-plugins-misc-linux
      - build-plugins-js-linux
      - build-plugins-code-linux

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Download ddc
        uses: actions/download-artifact@v4
        with: 
          name: ddc-linux
          path: artifacts/bin

      - 
        name: Download plugins
        uses: actions/download-artifact@v4
        with: 
          pattern: plugins-*-linux
          path: artifacts/plugins
          merge-multiple: "true"

      - 
        name: List artifacts
        run: ls -laR artifacts/
      - 
        name: Make ddc executable
        run: chmod +x artifacts/bin/ddc
      - 
        name: Run integration tests
        run: "cargo test --release -p dodeca-integration --test '*'"
        env: 
          DODECA_BIN: ${{ github.workspace }}/artifacts/bin/ddc
          DODECA_PLUGINS: ${{ github.workspace }}/artifacts/plugins


  build-ddc-macos: 
    name: Build ddc (macos)
    runs-on: depot-macos-15
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with: 
          components: clippy
          targets: wasm32-unknown-unknown

      - 
        name: Install Rust (nightly)
        uses: dtolnay/rust-toolchain@nightly
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Install wasm-pack
        run: brew install wasm-pack
      - 
        name: Build WASM
        run: cargo xtask wasm
      - 
        name: Build ddc
        run: cargo build --release -p dodeca
      - 
        name: Verify ddc binary exists
        run: ls -la target/release/ddc
      - 
        name: Run ddc unit tests
        run: cargo test --release -p dodeca --lib
      - 
        name: Clippy
        run: cargo clippy --all-features --all-targets -- -D warnings
      - 
        name: Upload artifact
        uses: actions/upload-artifact@v4
        with: 
          name: ddc-macos
          path: target/release/ddc


  build-plugins-image-macos: 
    name: Build plugins/image (macos)
    runs-on: depot-macos-15
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Build image plugins
        run: cargo build --release -p dodeca-webp -p dodeca-jxl -p dodeca-image
      - 
        name: Test image plugins
        run: cargo test --release -p dodeca-webp -p dodeca-jxl -p dodeca-image
      - 
        name: Upload plugin artifacts
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-image-macos
          path: "target/release/libdodeca_webp.dylib\ntarget/release/libdodeca_jxl.dylib\ntarget/release/libdodeca_image.dylib"
          retention-days: "1"


  build-plugins-web-macos: 
    name: Build plugins/web (macos)
    runs-on: depot-macos-15
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Build web plugins
        run: cargo build --release -p dodeca-minify -p dodeca-css -p dodeca-sass -p dodeca-html-diff
      - 
        name: Test web plugins
        run: cargo test --release -p dodeca-minify -p dodeca-css -p dodeca-sass -p dodeca-html-diff
      - 
        name: Upload plugin artifacts
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-web-macos
          path: "target/release/libdodeca_minify.dylib\ntarget/release/libdodeca_css.dylib\ntarget/release/libdodeca_sass.dylib\ntarget/release/libdodeca_html_diff.dylib"
          retention-days: "1"


  build-plugins-misc-macos: 
    name: Build plugins/misc (macos)
    runs-on: depot-macos-15
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Build misc plugins
        run: cargo build --release -p dodeca-fonts -p dodeca-pagefind -p dodeca-linkcheck -p dodeca-svgo -p dodeca-baseline
      - 
        name: Test misc plugins
        run: cargo test --release -p dodeca-fonts -p dodeca-pagefind -p dodeca-linkcheck -p dodeca-svgo -p dodeca-baseline
      - 
        name: Upload plugin artifacts
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-misc-macos
          path: "target/release/libdodeca_fonts.dylib\ntarget/release/libdodeca_pagefind.dylib\ntarget/release/libdodeca_linkcheck.dylib\ntarget/release/libdodeca_svgo.dylib\ntarget/release/libdodeca_baseline.dylib"
          retention-days: "1"


  build-plugins-js-macos: 
    name: Build plugins/js (macos)
    runs-on: depot-macos-15
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Build js plugins
        run: cargo build --release -p dodeca-js
      - 
        name: Test js plugins
        run: cargo test --release -p dodeca-js
      - 
        name: Upload plugin artifacts
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-js-macos
          path: target/release/libdodeca_js.dylib
          retention-days: "1"


  build-plugins-code-macos: 
    name: Build plugins/code (macos)
    runs-on: depot-macos-15
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Build code plugins
        run: cargo build --release -p dodeca-code-execution
      - 
        name: Test code plugins
        run: cargo test --release -p dodeca-code-execution
      - 
        name: Upload plugin artifacts
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-code-macos
          path: target/release/libdodeca_code_execution.dylib
          retention-days: "1"


  integration-macos: 
    name: Integration (macos)
    runs-on: depot-macos-15
    needs: 
      - build-ddc-macos
      - build-plugins-image-macos
      - build-plugins-web-macos
      - build-plugins-misc-macos
      - build-plugins-js-macos
      - build-plugins-code-macos

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Download ddc
        uses: actions/download-artifact@v4
        with: 
          name: ddc-macos
          path: artifacts/bin

      - 
        name: Download plugins
        uses: actions/download-artifact@v4
        with: 
          pattern: plugins-*-macos
          path: artifacts/plugins
          merge-multiple: "true"

      - 
        name: List artifacts
        run: ls -laR artifacts/
      - 
        name: Make ddc executable
        run: chmod +x artifacts/bin/ddc
      - 
        name: Run integration tests
        run: "cargo test --release -p dodeca-integration --test '*'"
        env: 
          DODECA_BIN: ${{ github.workspace }}/artifacts/bin/ddc
          DODECA_PLUGINS: ${{ github.workspace }}/artifacts/plugins


