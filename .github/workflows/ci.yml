# GENERATED BY: cargo xtask ci
# DO NOT EDIT - edit xtask/src/ci.rs instead

---
name: CI
"on": 
  push: 
    tags: 
      - v*

    branches: 
      - main

  pull_request: 
    branches: 
      - main

  workflow_dispatch: 
permissions: 
  contents: read

env: 
  CARGO_TERM_COLOR: always

jobs: 
  clippy: 
    name: Clippy
    runs-on: 
      - depot-ubuntu-24.04-32

    timeout-minutes: 30
    continue-on-error: true
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with: 
          toolchain: nightly-2025-12-19
          components: clippy
          targets: wasm32-unknown-unknown

      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
        with: 
          cache-on-failure: "true"
          cache-targets: "false"

      - 
        name: Clippy
        run: cargo +nightly-2025-12-19 -Z checksum-freshness -Z mtime-on-use clippy --all-features --all-targets -- -D warnings

  build-wasm: 
    name: Build WASM
    runs-on: 
      - depot-ubuntu-24.04-32

    timeout-minutes: 30
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with: 
          toolchain: nightly-2025-12-19
          targets: wasm32-unknown-unknown

      - 
        name: Add WASM target
        run: rustup target add wasm32-unknown-unknown
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
        with: 
          cache-on-failure: "true"
          cache-targets: "false"

      - 
        name: Install wasm-bindgen-cli
        run: cargo install wasm-bindgen-cli --locked
      - 
        name: Build WASM
        run: cargo xtask wasm
      - 
        name: Upload artifact
        uses: actions/upload-artifact@v4
        with: 
          name: dodeca-devtools-wasm
          path: crates/dodeca-devtools/pkg


  build-ddc-linux-x64: 
    name: Build ddc (linux-x64)
    runs-on: 
      - depot-ubuntu-24.04-32

    timeout-minutes: 30
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with: 
          toolchain: nightly-2025-12-19

      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
        with: 
          cache-on-failure: "true"
          cache-targets: "false"

      - 
        name: Build ddc
        run: cargo +nightly-2025-12-19 -Z checksum-freshness -Z mtime-on-use build --release -p dodeca --verbose
      - 
        name: Test ddc
        run: cargo +nightly-2025-12-19 -Z checksum-freshness -Z mtime-on-use test --release -p dodeca --bins
      - 
        name: Upload artifact
        uses: actions/upload-artifact@v4
        with: 
          name: ddc-linux-x64
          path: target/release/ddc


  build-cells-linux-x64-1: 
    name: Build cells (linux-x64) [cell-arborium, cell-code-execution, cell-css, cell-fonts, cell-html, cell-html-diff, cell-http, cell-image, cell-js]
    runs-on: 
      - depot-ubuntu-24.04-32

    timeout-minutes: 30
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with: 
          toolchain: nightly-2025-12-19

      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
        with: 
          cache-on-failure: "true"
          cache-targets: "true"

      - 
        name: Build cells
        run: cargo +nightly-2025-12-19 -Z checksum-freshness -Z mtime-on-use build --release -p cell-arborium --bin ddc-cell-arborium -p cell-code-execution --bin ddc-cell-code-execution -p cell-css --bin ddc-cell-css -p cell-fonts --bin ddc-cell-fonts -p cell-html --bin ddc-cell-html -p cell-html-diff --bin ddc-cell-html-diff -p cell-http --bin ddc-cell-http -p cell-image --bin ddc-cell-image -p cell-js --bin ddc-cell-js --verbose
      - 
        name: Test cells
        run: cargo +nightly-2025-12-19 -Z checksum-freshness -Z mtime-on-use test --release -p cell-arborium -p cell-code-execution -p cell-css -p cell-fonts -p cell-html -p cell-html-diff -p cell-http -p cell-image -p cell-js
      - 
        name: Upload artifact
        uses: actions/upload-artifact@v4
        with: 
          name: cells-linux-x64-1
          path: "target/release/ddc-cell-arborium\ntarget/release/ddc-cell-code-execution\ntarget/release/ddc-cell-css\ntarget/release/ddc-cell-fonts\ntarget/release/ddc-cell-html\ntarget/release/ddc-cell-html-diff\ntarget/release/ddc-cell-http\ntarget/release/ddc-cell-image\ntarget/release/ddc-cell-js"


  build-cells-linux-x64-2: 
    name: Build cells (linux-x64) [cell-jxl, cell-linkcheck, cell-markdown, cell-minify, cell-pagefind, cell-sass, cell-svgo, cell-tui, cell-webp]
    runs-on: 
      - depot-ubuntu-24.04-32

    timeout-minutes: 30
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with: 
          toolchain: nightly-2025-12-19

      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
        with: 
          cache-on-failure: "true"
          cache-targets: "true"

      - 
        name: Build cells
        run: cargo +nightly-2025-12-19 -Z checksum-freshness -Z mtime-on-use build --release -p cell-jxl --bin ddc-cell-jxl -p cell-linkcheck --bin ddc-cell-linkcheck -p cell-markdown --bin ddc-cell-markdown -p cell-minify --bin ddc-cell-minify -p cell-pagefind --bin ddc-cell-pagefind -p cell-sass --bin ddc-cell-sass -p cell-svgo --bin ddc-cell-svgo -p cell-tui --bin ddc-cell-tui -p cell-webp --bin ddc-cell-webp --verbose
      - 
        name: Test cells
        run: cargo +nightly-2025-12-19 -Z checksum-freshness -Z mtime-on-use test --release -p cell-jxl -p cell-linkcheck -p cell-markdown -p cell-minify -p cell-pagefind -p cell-sass -p cell-svgo -p cell-tui -p cell-webp
      - 
        name: Upload artifact
        uses: actions/upload-artifact@v4
        with: 
          name: cells-linux-x64-2
          path: "target/release/ddc-cell-jxl\ntarget/release/ddc-cell-linkcheck\ntarget/release/ddc-cell-markdown\ntarget/release/ddc-cell-minify\ntarget/release/ddc-cell-pagefind\ntarget/release/ddc-cell-sass\ntarget/release/ddc-cell-svgo\ntarget/release/ddc-cell-tui\ntarget/release/ddc-cell-webp"


  integration-linux-x64: 
    name: Integration (linux-x64)
    runs-on: 
      - depot-ubuntu-24.04-32

    timeout-minutes: 30
    needs: 
      - build-ddc-linux-x64
      - build-cells-linux-x64-1
      - build-cells-linux-x64-2

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with: 
          toolchain: nightly-2025-12-19

      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
        with: 
          cache-on-failure: "true"
          cache-targets: "false"

      - 
        name: Build integration-tests
        run: cargo +nightly-2025-12-19 -Z checksum-freshness -Z mtime-on-use build -p integration-tests
      - 
        name: Download ddc
        uses: actions/download-artifact@v4
        with: 
          name: ddc-linux-x64
          path: dist

      - 
        name: Download cells
        uses: actions/download-artifact@v4
        with: 
          pattern: cells-linux-x64-*
          path: dist
          merge-multiple: "true"

      - 
        name: Flatten cell directories
        run: find dist -mindepth 2 -type f -exec mv -t dist {} + 2>/dev/null || true; find dist -mindepth 1 -type d -empty -delete 2>/dev/null || true
      - 
        name: Prepare binaries
        run: chmod +x dist/ddc* && ls -la dist/
      - 
        name: Verify artifacts
        run: "#!/bin/bash\nset -euo pipefail\n\necho 'Verifying all required binaries exist in dist/'\nmissing=0\n\nif [[ ! -x dist/ddc ]]; then\n  echo '❌ MISSING: ddc'\n  missing=1\nelse\n  echo '✓ ddc'\nfi\n\nif [[ ! -x dist/ddc-cell-arborium ]]; then\n  echo '❌ MISSING: ddc-cell-arborium'\n  missing=1\nelse\n  echo '✓ ddc-cell-arborium'\nfi\n\nif [[ ! -x dist/ddc-cell-code-execution ]]; then\n  echo '❌ MISSING: ddc-cell-code-execution'\n  missing=1\nelse\n  echo '✓ ddc-cell-code-execution'\nfi\n\nif [[ ! -x dist/ddc-cell-css ]]; then\n  echo '❌ MISSING: ddc-cell-css'\n  missing=1\nelse\n  echo '✓ ddc-cell-css'\nfi\n\nif [[ ! -x dist/ddc-cell-fonts ]]; then\n  echo '❌ MISSING: ddc-cell-fonts'\n  missing=1\nelse\n  echo '✓ ddc-cell-fonts'\nfi\n\nif [[ ! -x dist/ddc-cell-html ]]; then\n  echo '❌ MISSING: ddc-cell-html'\n  missing=1\nelse\n  echo '✓ ddc-cell-html'\nfi\n\nif [[ ! -x dist/ddc-cell-html-diff ]]; then\n  echo '❌ MISSING: ddc-cell-html-diff'\n  missing=1\nelse\n  echo '✓ ddc-cell-html-diff'\nfi\n\nif [[ ! -x dist/ddc-cell-http ]]; then\n  echo '❌ MISSING: ddc-cell-http'\n  missing=1\nelse\n  echo '✓ ddc-cell-http'\nfi\n\nif [[ ! -x dist/ddc-cell-image ]]; then\n  echo '❌ MISSING: ddc-cell-image'\n  missing=1\nelse\n  echo '✓ ddc-cell-image'\nfi\n\nif [[ ! -x dist/ddc-cell-js ]]; then\n  echo '❌ MISSING: ddc-cell-js'\n  missing=1\nelse\n  echo '✓ ddc-cell-js'\nfi\n\nif [[ ! -x dist/ddc-cell-jxl ]]; then\n  echo '❌ MISSING: ddc-cell-jxl'\n  missing=1\nelse\n  echo '✓ ddc-cell-jxl'\nfi\n\nif [[ ! -x dist/ddc-cell-linkcheck ]]; then\n  echo '❌ MISSING: ddc-cell-linkcheck'\n  missing=1\nelse\n  echo '✓ ddc-cell-linkcheck'\nfi\n\nif [[ ! -x dist/ddc-cell-markdown ]]; then\n  echo '❌ MISSING: ddc-cell-markdown'\n  missing=1\nelse\n  echo '✓ ddc-cell-markdown'\nfi\n\nif [[ ! -x dist/ddc-cell-minify ]]; then\n  echo '❌ MISSING: ddc-cell-minify'\n  missing=1\nelse\n  echo '✓ ddc-cell-minify'\nfi\n\nif [[ ! -x dist/ddc-cell-pagefind ]]; then\n  echo '❌ MISSING: ddc-cell-pagefind'\n  missing=1\nelse\n  echo '✓ ddc-cell-pagefind'\nfi\n\nif [[ ! -x dist/ddc-cell-sass ]]; then\n  echo '❌ MISSING: ddc-cell-sass'\n  missing=1\nelse\n  echo '✓ ddc-cell-sass'\nfi\n\nif [[ ! -x dist/ddc-cell-svgo ]]; then\n  echo '❌ MISSING: ddc-cell-svgo'\n  missing=1\nelse\n  echo '✓ ddc-cell-svgo'\nfi\n\nif [[ ! -x dist/ddc-cell-tui ]]; then\n  echo '❌ MISSING: ddc-cell-tui'\n  missing=1\nelse\n  echo '✓ ddc-cell-tui'\nfi\n\nif [[ ! -x dist/ddc-cell-webp ]]; then\n  echo '❌ MISSING: ddc-cell-webp'\n  missing=1\nelse\n  echo '✓ ddc-cell-webp'\nfi\n\nif [[ $missing -eq 1 ]]; then\n  echo ''\n  echo 'ERROR: Some required binaries are missing!'\n  echo 'This usually means a cell build job failed or artifact upload was incomplete.'\n  exit 1\nfi\n\necho ''\necho 'All 19 binaries verified.'\n"
      - 
        name: Run integration tests
        run: cargo xtask integration --no-build
        env: 
          DODECA_BIN: ${{ github.workspace }}/dist/ddc
          DODECA_CELL_PATH: ${{ github.workspace }}/dist
          DODECA_TEST_FIXTURES_DIR: ${{ github.workspace }}/crates/integration-tests/fixtures


  assemble-linux-x64: 
    name: Assemble (linux-x64)
    runs-on: 
      - depot-ubuntu-24.04-32

    timeout-minutes: 30
    needs: 
      - integration-linux-x64
      - build-wasm

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download ddc
        uses: actions/download-artifact@v4
        with: 
          name: ddc-linux-x64
          path: target/release

      - 
        name: Download cells
        uses: actions/download-artifact@v4
        with: 
          pattern: cells-linux-x64-*
          path: target/release
          merge-multiple: "true"

      - 
        name: Flatten cell directories
        run: find target/release -mindepth 2 -type f -exec mv -t target/release {} + 2>/dev/null || true; find target/release -mindepth 1 -type d -empty -delete 2>/dev/null || true
      - 
        name: Download WASM
        uses: actions/download-artifact@v4
        with: 
          name: dodeca-devtools-wasm
          path: crates/dodeca-devtools/pkg

      - 
        name: Install xz (macOS)
        run: if command -v brew >/dev/null 2>&1; then HOMEBREW_NO_AUTO_UPDATE=1 brew install xz; fi
      - 
        name: List binaries
        run: ls -la target/release/
      - 
        name: Assemble archive
        run: bash scripts/assemble-archive.sh x86_64-unknown-linux-gnu
      - 
        name: Upload artifact
        uses: actions/upload-artifact@v4
        with: 
          name: build-linux-x64
          path: dodeca-x86_64-unknown-linux-gnu.tar.xz


  build-ddc-macos-arm64: 
    name: Build ddc (macos-arm64)
    runs-on: 
      - mac-arm64-oakhost

    timeout-minutes: 30
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with: 
          toolchain: nightly-2025-12-19

      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
        with: 
          cache-on-failure: "true"
          cache-targets: "false"

      - 
        name: Build ddc
        run: cargo +nightly-2025-12-19 -Z checksum-freshness -Z mtime-on-use build --release -p dodeca --verbose
      - 
        name: Test ddc
        run: cargo +nightly-2025-12-19 -Z checksum-freshness -Z mtime-on-use test --release -p dodeca --bins
      - 
        name: Upload artifact
        uses: actions/upload-artifact@v4
        with: 
          name: ddc-macos-arm64
          path: target/release/ddc


  build-cells-macos-arm64-1: 
    name: Build cells (macos-arm64) [cell-arborium, cell-code-execution, cell-css, cell-fonts, cell-html, cell-html-diff, cell-http, cell-image, cell-js]
    runs-on: 
      - mac-arm64-oakhost

    timeout-minutes: 30
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with: 
          toolchain: nightly-2025-12-19

      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
        with: 
          cache-on-failure: "true"
          cache-targets: "true"

      - 
        name: Build cells
        run: cargo +nightly-2025-12-19 -Z checksum-freshness -Z mtime-on-use build --release -p cell-arborium --bin ddc-cell-arborium -p cell-code-execution --bin ddc-cell-code-execution -p cell-css --bin ddc-cell-css -p cell-fonts --bin ddc-cell-fonts -p cell-html --bin ddc-cell-html -p cell-html-diff --bin ddc-cell-html-diff -p cell-http --bin ddc-cell-http -p cell-image --bin ddc-cell-image -p cell-js --bin ddc-cell-js --verbose
      - 
        name: Test cells
        run: cargo +nightly-2025-12-19 -Z checksum-freshness -Z mtime-on-use test --release -p cell-arborium -p cell-code-execution -p cell-css -p cell-fonts -p cell-html -p cell-html-diff -p cell-http -p cell-image -p cell-js
      - 
        name: Upload artifact
        uses: actions/upload-artifact@v4
        with: 
          name: cells-macos-arm64-1
          path: "target/release/ddc-cell-arborium\ntarget/release/ddc-cell-code-execution\ntarget/release/ddc-cell-css\ntarget/release/ddc-cell-fonts\ntarget/release/ddc-cell-html\ntarget/release/ddc-cell-html-diff\ntarget/release/ddc-cell-http\ntarget/release/ddc-cell-image\ntarget/release/ddc-cell-js"


  build-cells-macos-arm64-2: 
    name: Build cells (macos-arm64) [cell-jxl, cell-linkcheck, cell-markdown, cell-minify, cell-pagefind, cell-sass, cell-svgo, cell-tui, cell-webp]
    runs-on: 
      - mac-arm64-oakhost

    timeout-minutes: 30
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with: 
          toolchain: nightly-2025-12-19

      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
        with: 
          cache-on-failure: "true"
          cache-targets: "true"

      - 
        name: Build cells
        run: cargo +nightly-2025-12-19 -Z checksum-freshness -Z mtime-on-use build --release -p cell-jxl --bin ddc-cell-jxl -p cell-linkcheck --bin ddc-cell-linkcheck -p cell-markdown --bin ddc-cell-markdown -p cell-minify --bin ddc-cell-minify -p cell-pagefind --bin ddc-cell-pagefind -p cell-sass --bin ddc-cell-sass -p cell-svgo --bin ddc-cell-svgo -p cell-tui --bin ddc-cell-tui -p cell-webp --bin ddc-cell-webp --verbose
      - 
        name: Test cells
        run: cargo +nightly-2025-12-19 -Z checksum-freshness -Z mtime-on-use test --release -p cell-jxl -p cell-linkcheck -p cell-markdown -p cell-minify -p cell-pagefind -p cell-sass -p cell-svgo -p cell-tui -p cell-webp
      - 
        name: Upload artifact
        uses: actions/upload-artifact@v4
        with: 
          name: cells-macos-arm64-2
          path: "target/release/ddc-cell-jxl\ntarget/release/ddc-cell-linkcheck\ntarget/release/ddc-cell-markdown\ntarget/release/ddc-cell-minify\ntarget/release/ddc-cell-pagefind\ntarget/release/ddc-cell-sass\ntarget/release/ddc-cell-svgo\ntarget/release/ddc-cell-tui\ntarget/release/ddc-cell-webp"


  integration-macos-arm64: 
    name: Integration (macos-arm64)
    runs-on: 
      - mac-arm64-oakhost

    timeout-minutes: 30
    needs: 
      - build-ddc-macos-arm64
      - build-cells-macos-arm64-1
      - build-cells-macos-arm64-2

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with: 
          toolchain: nightly-2025-12-19

      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
        with: 
          cache-on-failure: "true"
          cache-targets: "false"

      - 
        name: Build integration-tests
        run: cargo +nightly-2025-12-19 -Z checksum-freshness -Z mtime-on-use build -p integration-tests
      - 
        name: Download ddc
        uses: actions/download-artifact@v4
        with: 
          name: ddc-macos-arm64
          path: dist

      - 
        name: Download cells
        uses: actions/download-artifact@v4
        with: 
          pattern: cells-macos-arm64-*
          path: dist
          merge-multiple: "true"

      - 
        name: Flatten cell directories
        run: find dist -mindepth 2 -type f -exec mv -t dist {} + 2>/dev/null || true; find dist -mindepth 1 -type d -empty -delete 2>/dev/null || true
      - 
        name: Prepare binaries
        run: chmod +x dist/ddc* && ls -la dist/
      - 
        name: Verify artifacts
        run: "#!/bin/bash\nset -euo pipefail\n\necho 'Verifying all required binaries exist in dist/'\nmissing=0\n\nif [[ ! -x dist/ddc ]]; then\n  echo '❌ MISSING: ddc'\n  missing=1\nelse\n  echo '✓ ddc'\nfi\n\nif [[ ! -x dist/ddc-cell-arborium ]]; then\n  echo '❌ MISSING: ddc-cell-arborium'\n  missing=1\nelse\n  echo '✓ ddc-cell-arborium'\nfi\n\nif [[ ! -x dist/ddc-cell-code-execution ]]; then\n  echo '❌ MISSING: ddc-cell-code-execution'\n  missing=1\nelse\n  echo '✓ ddc-cell-code-execution'\nfi\n\nif [[ ! -x dist/ddc-cell-css ]]; then\n  echo '❌ MISSING: ddc-cell-css'\n  missing=1\nelse\n  echo '✓ ddc-cell-css'\nfi\n\nif [[ ! -x dist/ddc-cell-fonts ]]; then\n  echo '❌ MISSING: ddc-cell-fonts'\n  missing=1\nelse\n  echo '✓ ddc-cell-fonts'\nfi\n\nif [[ ! -x dist/ddc-cell-html ]]; then\n  echo '❌ MISSING: ddc-cell-html'\n  missing=1\nelse\n  echo '✓ ddc-cell-html'\nfi\n\nif [[ ! -x dist/ddc-cell-html-diff ]]; then\n  echo '❌ MISSING: ddc-cell-html-diff'\n  missing=1\nelse\n  echo '✓ ddc-cell-html-diff'\nfi\n\nif [[ ! -x dist/ddc-cell-http ]]; then\n  echo '❌ MISSING: ddc-cell-http'\n  missing=1\nelse\n  echo '✓ ddc-cell-http'\nfi\n\nif [[ ! -x dist/ddc-cell-image ]]; then\n  echo '❌ MISSING: ddc-cell-image'\n  missing=1\nelse\n  echo '✓ ddc-cell-image'\nfi\n\nif [[ ! -x dist/ddc-cell-js ]]; then\n  echo '❌ MISSING: ddc-cell-js'\n  missing=1\nelse\n  echo '✓ ddc-cell-js'\nfi\n\nif [[ ! -x dist/ddc-cell-jxl ]]; then\n  echo '❌ MISSING: ddc-cell-jxl'\n  missing=1\nelse\n  echo '✓ ddc-cell-jxl'\nfi\n\nif [[ ! -x dist/ddc-cell-linkcheck ]]; then\n  echo '❌ MISSING: ddc-cell-linkcheck'\n  missing=1\nelse\n  echo '✓ ddc-cell-linkcheck'\nfi\n\nif [[ ! -x dist/ddc-cell-markdown ]]; then\n  echo '❌ MISSING: ddc-cell-markdown'\n  missing=1\nelse\n  echo '✓ ddc-cell-markdown'\nfi\n\nif [[ ! -x dist/ddc-cell-minify ]]; then\n  echo '❌ MISSING: ddc-cell-minify'\n  missing=1\nelse\n  echo '✓ ddc-cell-minify'\nfi\n\nif [[ ! -x dist/ddc-cell-pagefind ]]; then\n  echo '❌ MISSING: ddc-cell-pagefind'\n  missing=1\nelse\n  echo '✓ ddc-cell-pagefind'\nfi\n\nif [[ ! -x dist/ddc-cell-sass ]]; then\n  echo '❌ MISSING: ddc-cell-sass'\n  missing=1\nelse\n  echo '✓ ddc-cell-sass'\nfi\n\nif [[ ! -x dist/ddc-cell-svgo ]]; then\n  echo '❌ MISSING: ddc-cell-svgo'\n  missing=1\nelse\n  echo '✓ ddc-cell-svgo'\nfi\n\nif [[ ! -x dist/ddc-cell-tui ]]; then\n  echo '❌ MISSING: ddc-cell-tui'\n  missing=1\nelse\n  echo '✓ ddc-cell-tui'\nfi\n\nif [[ ! -x dist/ddc-cell-webp ]]; then\n  echo '❌ MISSING: ddc-cell-webp'\n  missing=1\nelse\n  echo '✓ ddc-cell-webp'\nfi\n\nif [[ $missing -eq 1 ]]; then\n  echo ''\n  echo 'ERROR: Some required binaries are missing!'\n  echo 'This usually means a cell build job failed or artifact upload was incomplete.'\n  exit 1\nfi\n\necho ''\necho 'All 19 binaries verified.'\n"
      - 
        name: Run integration tests
        run: cargo xtask integration --no-build
        env: 
          DODECA_BIN: ${{ github.workspace }}/dist/ddc
          DODECA_CELL_PATH: ${{ github.workspace }}/dist
          DODECA_TEST_FIXTURES_DIR: ${{ github.workspace }}/crates/integration-tests/fixtures


  assemble-macos-arm64: 
    name: Assemble (macos-arm64)
    runs-on: 
      - mac-arm64-oakhost

    timeout-minutes: 30
    needs: 
      - integration-macos-arm64
      - build-wasm

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download ddc
        uses: actions/download-artifact@v4
        with: 
          name: ddc-macos-arm64
          path: target/release

      - 
        name: Download cells
        uses: actions/download-artifact@v4
        with: 
          pattern: cells-macos-arm64-*
          path: target/release
          merge-multiple: "true"

      - 
        name: Flatten cell directories
        run: find target/release -mindepth 2 -type f -exec mv -t target/release {} + 2>/dev/null || true; find target/release -mindepth 1 -type d -empty -delete 2>/dev/null || true
      - 
        name: Download WASM
        uses: actions/download-artifact@v4
        with: 
          name: dodeca-devtools-wasm
          path: crates/dodeca-devtools/pkg

      - 
        name: Install xz (macOS)
        run: if command -v brew >/dev/null 2>&1; then HOMEBREW_NO_AUTO_UPDATE=1 brew install xz; fi
      - 
        name: List binaries
        run: ls -la target/release/
      - 
        name: Assemble archive
        run: bash scripts/assemble-archive.sh aarch64-apple-darwin
      - 
        name: Upload artifact
        uses: actions/upload-artifact@v4
        with: 
          name: build-macos-arm64
          path: dodeca-aarch64-apple-darwin.tar.xz


  release: 
    name: Release
    runs-on: 
      - ubuntu-latest

    timeout-minutes: 30
    needs: 
      - assemble-linux-x64
      - assemble-macos-arm64

    if: "startsWith(github.ref, 'refs/tags/')"
    env: 
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}

    permissions: 
      contents: write

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download all artifacts
        uses: actions/download-artifact@v4
        with: 
          path: dist
          pattern: build-*
          merge-multiple: "true"

      - 
        name: List artifacts (before flatten)
        run: ls -laR dist/
      - 
        name: Flatten artifact directories
        run: find dist -mindepth 2 -type f -exec mv -t dist {} + 2>/dev/null || true; find dist -mindepth 1 -type d -empty -delete 2>/dev/null || true
      - 
        name: List artifacts (after flatten)
        run: ls -la dist/
      - 
        name: Create GitHub Release
        run: "shopt -s nullglob\n# Rename install.sh to dodeca-installer.sh for the release\ncp install.sh dist/dodeca-installer.sh\ngh release create \"${{ github.ref_name }}\" \\\n  --title \"dodeca ${{ github.ref_name }}\" \\\n  --generate-notes \\\n  dist/*.tar.xz dist/*.zip dist/dodeca-installer.sh"
        shell: bash
      - 
        name: Update Homebrew tap
        run: "bash scripts/update-homebrew.sh \"${{ github.ref_name }}\""
        shell: bash

