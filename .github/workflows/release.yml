# GENERATED BY: cargo xtask ci
# DO NOT EDIT - edit xtask/src/ci.rs instead

---
name: Release
"on": 
  push: 
    tags: 
      - v*

  pull_request: 
    branches: 
      - main

  workflow_dispatch: 
permissions: 
  contents: write

env: 
  CARGO_TERM_COLOR: always

jobs: 
  build-linux-x64: 
    name: Build (linux-x64)
    runs-on: depot-ubuntu-24.04-32
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with: 
          targets: x86_64-unknown-linux-gnu

      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Install wasm-bindgen
        run: "cargo install wasm-bindgen-cli --version $(cargo metadata --format-version 1 | jq -r '.packages[] | select(.name == \"wasm-bindgen\") | .version' | head -1)"
        shell: bash
      - 
        name: Add wasm32 target
        run: rustup target add wasm32-unknown-unknown
      - 
        name: Build livereload WASM
        run: "cargo build -p livereload-client --target wasm32-unknown-unknown --release\nwasm-bindgen --target web --out-dir crates/livereload-client/pkg target/wasm32-unknown-unknown/release/livereload_client.wasm"
        shell: bash
      - 
        name: Build ddc
        run: cargo build --release --target x86_64-unknown-linux-gnu -p dodeca
      - 
        name: Build plugins
        run: cargo build --release --target x86_64-unknown-linux-gnu -p dodeca-baseline -p dodeca-css -p dodeca-js -p dodeca-jxl -p dodeca-minify -p dodeca-pagefind -p dodeca-sass -p dodeca-svgo -p dodeca-webp
      - 
        name: Assemble archive
        run: "mkdir -p staging\ncp target/x86_64-unknown-linux-gnu/release/ddc staging/\nmkdir -p staging/plugins\ncp target/x86_64-unknown-linux-gnu/release/libdodeca_baseline.so target/x86_64-unknown-linux-gnu/release/libdodeca_css.so target/x86_64-unknown-linux-gnu/release/libdodeca_js.so target/x86_64-unknown-linux-gnu/release/libdodeca_jxl.so target/x86_64-unknown-linux-gnu/release/libdodeca_minify.so target/x86_64-unknown-linux-gnu/release/libdodeca_pagefind.so target/x86_64-unknown-linux-gnu/release/libdodeca_sass.so target/x86_64-unknown-linux-gnu/release/libdodeca_svgo.so target/x86_64-unknown-linux-gnu/release/libdodeca_webp.so staging/plugins/\ntar -cJf \"dodeca-x86_64-unknown-linux-gnu.tar.xz\" -C staging ."
        shell: bash
      - 
        name: Upload artifact
        uses: actions/upload-artifact@v4
        with: 
          name: build-linux-x64
          path: dodeca-x86_64-unknown-linux-gnu.tar.xz


  build-linux-arm64: 
    name: Build (linux-arm64)
    runs-on: depot-ubuntu-24.04-arm-32
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with: 
          targets: aarch64-unknown-linux-gnu

      - 
        name: Install cross-compilation tools
        run: sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Install wasm-bindgen
        run: "cargo install wasm-bindgen-cli --version $(cargo metadata --format-version 1 | jq -r '.packages[] | select(.name == \"wasm-bindgen\") | .version' | head -1)"
        shell: bash
      - 
        name: Add wasm32 target
        run: rustup target add wasm32-unknown-unknown
      - 
        name: Build livereload WASM
        run: "cargo build -p livereload-client --target wasm32-unknown-unknown --release\nwasm-bindgen --target web --out-dir crates/livereload-client/pkg target/wasm32-unknown-unknown/release/livereload_client.wasm"
        shell: bash
      - 
        name: Build ddc
        run: cargo build --release --target aarch64-unknown-linux-gnu -p dodeca
        env: 
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc

      - 
        name: Build plugins
        run: cargo build --release --target aarch64-unknown-linux-gnu -p dodeca-baseline -p dodeca-css -p dodeca-js -p dodeca-jxl -p dodeca-minify -p dodeca-pagefind -p dodeca-sass -p dodeca-svgo -p dodeca-webp
        env: 
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc

      - 
        name: Assemble archive
        run: "mkdir -p staging\ncp target/aarch64-unknown-linux-gnu/release/ddc staging/\nmkdir -p staging/plugins\ncp target/aarch64-unknown-linux-gnu/release/libdodeca_baseline.so target/aarch64-unknown-linux-gnu/release/libdodeca_css.so target/aarch64-unknown-linux-gnu/release/libdodeca_js.so target/aarch64-unknown-linux-gnu/release/libdodeca_jxl.so target/aarch64-unknown-linux-gnu/release/libdodeca_minify.so target/aarch64-unknown-linux-gnu/release/libdodeca_pagefind.so target/aarch64-unknown-linux-gnu/release/libdodeca_sass.so target/aarch64-unknown-linux-gnu/release/libdodeca_svgo.so target/aarch64-unknown-linux-gnu/release/libdodeca_webp.so staging/plugins/\ntar -cJf \"dodeca-aarch64-unknown-linux-gnu.tar.xz\" -C staging ."
        shell: bash
      - 
        name: Upload artifact
        uses: actions/upload-artifact@v4
        with: 
          name: build-linux-arm64
          path: dodeca-aarch64-unknown-linux-gnu.tar.xz


  build-macos-x64: 
    name: Build (macos-x64)
    runs-on: depot-macos-latest
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with: 
          targets: x86_64-apple-darwin

      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Install wasm-bindgen
        run: "cargo install wasm-bindgen-cli --version $(cargo metadata --format-version 1 | jq -r '.packages[] | select(.name == \"wasm-bindgen\") | .version' | head -1)"
        shell: bash
      - 
        name: Add wasm32 target
        run: rustup target add wasm32-unknown-unknown
      - 
        name: Build livereload WASM
        run: "cargo build -p livereload-client --target wasm32-unknown-unknown --release\nwasm-bindgen --target web --out-dir crates/livereload-client/pkg target/wasm32-unknown-unknown/release/livereload_client.wasm"
        shell: bash
      - 
        name: Build ddc
        run: cargo build --release --target x86_64-apple-darwin -p dodeca
      - 
        name: Build plugins
        run: cargo build --release --target x86_64-apple-darwin -p dodeca-baseline -p dodeca-css -p dodeca-js -p dodeca-jxl -p dodeca-minify -p dodeca-pagefind -p dodeca-sass -p dodeca-svgo -p dodeca-webp
      - 
        name: Assemble archive
        run: "mkdir -p staging\ncp target/x86_64-apple-darwin/release/ddc staging/\nmkdir -p staging/plugins\ncp target/x86_64-apple-darwin/release/libdodeca_baseline.dylib target/x86_64-apple-darwin/release/libdodeca_css.dylib target/x86_64-apple-darwin/release/libdodeca_js.dylib target/x86_64-apple-darwin/release/libdodeca_jxl.dylib target/x86_64-apple-darwin/release/libdodeca_minify.dylib target/x86_64-apple-darwin/release/libdodeca_pagefind.dylib target/x86_64-apple-darwin/release/libdodeca_sass.dylib target/x86_64-apple-darwin/release/libdodeca_svgo.dylib target/x86_64-apple-darwin/release/libdodeca_webp.dylib staging/plugins/\ntar -cJf \"dodeca-x86_64-apple-darwin.tar.xz\" -C staging ."
        shell: bash
      - 
        name: Upload artifact
        uses: actions/upload-artifact@v4
        with: 
          name: build-macos-x64
          path: dodeca-x86_64-apple-darwin.tar.xz


  build-macos-arm64: 
    name: Build (macos-arm64)
    runs-on: depot-macos-latest
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with: 
          targets: aarch64-apple-darwin

      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Install wasm-bindgen
        run: "cargo install wasm-bindgen-cli --version $(cargo metadata --format-version 1 | jq -r '.packages[] | select(.name == \"wasm-bindgen\") | .version' | head -1)"
        shell: bash
      - 
        name: Add wasm32 target
        run: rustup target add wasm32-unknown-unknown
      - 
        name: Build livereload WASM
        run: "cargo build -p livereload-client --target wasm32-unknown-unknown --release\nwasm-bindgen --target web --out-dir crates/livereload-client/pkg target/wasm32-unknown-unknown/release/livereload_client.wasm"
        shell: bash
      - 
        name: Build ddc
        run: cargo build --release --target aarch64-apple-darwin -p dodeca
      - 
        name: Build plugins
        run: cargo build --release --target aarch64-apple-darwin -p dodeca-baseline -p dodeca-css -p dodeca-js -p dodeca-jxl -p dodeca-minify -p dodeca-pagefind -p dodeca-sass -p dodeca-svgo -p dodeca-webp
      - 
        name: Assemble archive
        run: "mkdir -p staging\ncp target/aarch64-apple-darwin/release/ddc staging/\nmkdir -p staging/plugins\ncp target/aarch64-apple-darwin/release/libdodeca_baseline.dylib target/aarch64-apple-darwin/release/libdodeca_css.dylib target/aarch64-apple-darwin/release/libdodeca_js.dylib target/aarch64-apple-darwin/release/libdodeca_jxl.dylib target/aarch64-apple-darwin/release/libdodeca_minify.dylib target/aarch64-apple-darwin/release/libdodeca_pagefind.dylib target/aarch64-apple-darwin/release/libdodeca_sass.dylib target/aarch64-apple-darwin/release/libdodeca_svgo.dylib target/aarch64-apple-darwin/release/libdodeca_webp.dylib staging/plugins/\ntar -cJf \"dodeca-aarch64-apple-darwin.tar.xz\" -C staging ."
        shell: bash
      - 
        name: Upload artifact
        uses: actions/upload-artifact@v4
        with: 
          name: build-macos-arm64
          path: dodeca-aarch64-apple-darwin.tar.xz


  build-windows-x64: 
    name: Build (windows-x64)
    runs-on: depot-windows-2022-16
    env: 
      RUSTFLAGS: "-Ctarget-feature=+crt-static"

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with: 
          targets: x86_64-pc-windows-msvc

      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Install wasm-bindgen
        run: "cargo install wasm-bindgen-cli --version $(cargo metadata --format-version 1 | jq -r '.packages[] | select(.name == \"wasm-bindgen\") | .version' | head -1)"
        shell: bash
      - 
        name: Add wasm32 target
        run: rustup target add wasm32-unknown-unknown
      - 
        name: Build livereload WASM
        run: "cargo build -p livereload-client --target wasm32-unknown-unknown --release\nwasm-bindgen --target web --out-dir crates/livereload-client/pkg target/wasm32-unknown-unknown/release/livereload_client.wasm"
        shell: bash
      - 
        name: Build ddc
        run: cargo build --release --target x86_64-pc-windows-msvc -p dodeca
      - 
        name: Build plugins
        run: cargo build --release --target x86_64-pc-windows-msvc -p dodeca-baseline -p dodeca-css -p dodeca-js -p dodeca-jxl -p dodeca-minify -p dodeca-pagefind -p dodeca-sass -p dodeca-svgo -p dodeca-webp
      - 
        name: Assemble archive
        run: "mkdir -p staging\ncp target/x86_64-pc-windows-msvc/release/ddc.exe staging/\nmkdir -p staging/plugins\ncp target/x86_64-pc-windows-msvc/release/dodeca_baseline.dll target/x86_64-pc-windows-msvc/release/dodeca_css.dll target/x86_64-pc-windows-msvc/release/dodeca_js.dll target/x86_64-pc-windows-msvc/release/dodeca_jxl.dll target/x86_64-pc-windows-msvc/release/dodeca_minify.dll target/x86_64-pc-windows-msvc/release/dodeca_pagefind.dll target/x86_64-pc-windows-msvc/release/dodeca_sass.dll target/x86_64-pc-windows-msvc/release/dodeca_svgo.dll target/x86_64-pc-windows-msvc/release/dodeca_webp.dll staging/plugins/\ncd staging && 7z a -tzip \"../dodeca-x86_64-pc-windows-msvc.zip\" ."
        shell: bash
      - 
        name: Upload artifact
        uses: actions/upload-artifact@v4
        with: 
          name: build-windows-x64
          path: dodeca-x86_64-pc-windows-msvc.zip


  release: 
    name: Create Release
    runs-on: ubuntu-latest
    needs: 
      - build-linux-x64
      - build-linux-arm64
      - build-macos-x64
      - build-macos-arm64
      - build-windows-x64

    if: "startsWith(github.ref, 'refs/tags/')"
    env: 
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download all artifacts
        uses: actions/download-artifact@v4
        with: 
          path: dist
          pattern: build-*
          merge-multiple: "true"

      - 
        name: List artifacts
        run: find dist -type f | sort
      - 
        name: Generate checksums
        run: "cd dist\nsha256sum * > SHA256SUMS\ncat SHA256SUMS"
        shell: bash
      - 
        name: Create GitHub Release
        run: "gh release create \"${{ github.ref_name }}\" \\\n  --title \"dodeca ${{ github.ref_name }}\" \\\n  --generate-notes \\\n  dist/*"
        shell: bash

